openapi: "3.0.2"
info:
  title: API Title
  version: 1.0.1
servers:
  # Added by API Auto Mocking Plugin
  - url: "http://localhost:3000/api/v1"
    description: "ローカル環境"
  - url: "https://server.test/api/v1"
    description: "本番環境"

tags:
  - name: auth
    description: JWT情報
  - name: users
    description: ユーザ情報
  - name: arts
    description: アート情報
  - name: stamps
    description: stamp情報
  - name: QR
    description: QR関連

paths:
  /auth/signin:
    post:
      tags:
        - auth
      summary: ユーザーログイン
      description: メールアドレスとパスワードを使用してユーザーをログインします。
      requestBody:
        $ref: "#/components/requestBodies/SignInRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SigninResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          description: ユーザが存在せずログインができない場合。
          $ref: "#/components/responses/UnauthorizedResponse"
        "404":
          $ref: "#/components/responses/NotFoundResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /signup:
    post:
      tags:
        - auth
      summary: 会員登録
      description: リクエストBodyの内容を登録する
      requestBody:
        $ref: "#/components/requestBodies/SignUpRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SignUpResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "409":
          $ref: "#/components/responses/AlreadyEmailResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /signout:
    post:
      summary: 会員のログアウト
      description: JWTTokenを削除して会員をログアウトさせる。
      tags:
        - auth
      security:
        - Bearer: []
      responses:
        "201":
          $ref: "#/components/responses/SignOutResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"

  /users/email-change/{user_id}:
    # TODO: tokenテーブルにemailを保存。tokenが正しい場合に、emailを更新するため。
    post:
      summary: 新しいメールアドレス受け取る。
      description: 1.新しいメールアドレスを受け取る<br>
        2.メールアドレスが既に登録されていなければメールアドレス宛にtokenを付与したリンクを送る。

      tags:
        - users
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/EmailRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/EmailTransmissionSuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "409":
          $ref: "#/components/responses/AlreadyEmailResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /users/email-change/verify/{user_id}:
    put:
      summary: メールアドレス変更
      description:
        1.tokenをチェックし一致していればメールアドレスを更新する。<br>
        - tokenが不正なら403を返す。
        - tokenが正常なら201を返す。
      tags:
        - users
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/UserTokenRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "403":
          $ref: "#/components/responses/ForbiddenResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /users/password-change/{user_id}:
    put:
      summary: パスワード変更
      description: 新しいパスワードに変更する。
      tags:
        - users
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/PasswordChangeRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /users/password-reset/{user_id}:
    post:
      summary: パスワードリセット
      description:
        1.メールアドレスを受け取り、存在すればメールアドレス宛にリンクを送信<br>
        - 存在しない場合は、401を返す。<br>
        2.リンクにアクセスし、パスポートのリセットを行う。
      tags:
        - users
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/EmailRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"

  /users/password-reset/verify/{user_id}:
    put:
      summary: パスワードリセット
      description: 1.tokenを受け取り、正常ならpasswordを更新する。<br>
        2.不正な値なら403を返す。
      tags:
        - users
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/PasswordResetRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "403":
          $ref: "#/components/responses/ForbiddenResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /users/others-change/{user_id}:
    put:
      summary: 他情報変更
      description: 年齢、都道府県、性別の変更を行う。
      tags:
        - users
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/user_id"
      requestBody:
        $ref: "#/components/requestBodies/OthersChangeRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"

  /arts:
    get:
      summary: 作品を取得する。
      description: すべての作品を取得する。
      tags:
        - arts
      responses:
        "200":
          $ref: "#/components/responses/ArtsResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /arts/{art_id}:
    get:
      summary: 作品の詳細情報を取得。
      description: art_idの作品のの詳細情報を取得する。
      tags:
        - arts
      parameters:
        - $ref: "#/components/parameters/art_id"
      responses:
        "200":
          $ref: "#/components/responses/ArtsDetailResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /arts/author:
    get:
      summary: 作者の作品を取得する。
      description: 作者の「あいうえお」順にして返す。
      tags:
        - arts
      responses:
        "200":
          $ref: "#/components/responses/ArtsResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /arts/{user_id}/saved:
    get:
      summary: ユーザが保存した作品を取得する。
      description: ユーザIDを渡し、保存した作品を返す。
      tags:
        - arts
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/user_id"
      responses:
        "200":
          $ref: "#/components/responses/ArtsResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"
  /arts/{art_id}/save: # TODO: save機能のエンドポイント
    post:
      summary: ユーザが作品を保存する。
      description: ユーザIDとarts_idを渡し、作品を保存する。
      tags:
        - arts
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/art_id"
      requestBody:
        $ref: "#/components/requestBodies/ArtUserIdSaveRequestBody"
      responses:
        "201":
          $ref: "#/components/responses/SuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"

  /stamps/{user_id}:
    get:
      summary: スタンプを取得する。
      description: ユーザのスタンプを地域ごとに取得する。
      tags:
        - stamps
      security:
        - Bearer: []
      parameters:
        - $ref: "#/components/parameters/user_id"
      responses:
        "200":
          $ref: "#/components/responses/StampsResponse"
        "400":
          $ref: "#/components/responses/BadRequestResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedResponse"
        "500":
          $ref: "#/components/responses/InternalServerErrorResponse"

components:
  parameters:
    user_id:
      name: user_id
      in: path
      description: ユーザID
      required: true
      schema:
        type: string
        example: "hello world"
    art_id:
      name: art_id
      in: path
      description: アートID
      required: true
      schema:
        type: string
        example: "hello world"

  requestBodies:
    SignInRequestBody:
      description: signin user
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SignInModel"

    SignUpRequestBody:
      description: Signup user
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SignUpModel"

    EmailRequestBody:
      description: email change
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/EmailModel"

    UserTokenRequestBody:
      description: user token
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/UserTokenModel"

    PasswordResetRequestBody:
      description: password reset
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/PasswordResetModel"

    PasswordChangeRequestBody:
      description: password change
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/PasswordModel"

    OthersChangeRequestBody:
      description: その他情報変更
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/OthersChangeModel"
    ArtUserIdSaveRequestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ArtUserIdSaveModel"
  schemas:
    SignInModel:
      description: SignIn Model
      required:
        - email
        - password
      type: object
      properties:
        email:
          type: string
        password:
          type: string
      additionalProperties: false
    SignUpModel:
      description: SignUp Model
      required:
        - email
        - password
        - age_group
        - gender
        - prefecture
      type: object
      properties:
        email:
          type: string
        password:
          type: string
        age_group:
          type: integer
        gender:
          type: integer
        prefecture:
          type: integer
      additionalProperties: false

    PasswordModel:
      description: password Model
      required:
        - password
      type: object
      properties:
        password:
          type: string
      additionalProperties: false
    EmailModel:
      description: email Model
      required:
        - email
      type: object
      properties:
        email:
          type: string
      additionalProperties: false

    UserTokenModel:
      description: user token Model
      required:
        - token
        - email
      type: object
      properties:
        token:
          type: string
        email:
          type: string
      additionalProperties: false

    PasswordResetModel:
      description: password reset model
      required:
        - token
        - password
      type: object
      properties:
        token:
          type: string
        password:
          type: string
      additionalProperties: false

    OthersChangeModel:
      description: other change Model
      required:
        - gender
        - age-group
        - prefectures
      type: object
      properties:
        gender:
          type: integer
        age-group:
          type: integer
        prefectures:
          type: integer
      additionalProperties: false

    ArtUserIdSaveModel:
      description: ユーザが作品を保存する
      required:
        - user_id
      type: object
      properties:
        user_id:
          type: string
      additionalProperties: false
    ArtsModel:
      description: Response Arts Model.
      type: object
      properties: # TODO: 作品がユーザに保存されているかを返す。
        arts.id:
          type: string
        arts.name:
          type: string
        arts.address:
          type: string
        arts.image_path:
          type: array
          items:
            type: string
        authors.name:
          type: string

    ArtsDetailModel:
      description: Response Arts Detail Model.
      type: object
      properties: # TODO: 作品がユーザに保存されているかを返す。
        arts.id:
          type: string
        arts.name:
          type: string
        arts.address:
          type: string
        arts.image_path:
          type: array
          items:
            type: string
        arts.description:
          type: string
        arts.is_public:
          type: boolean
        arts.created_year:
          type: integer
          example: 2023 # NOTE: exampleを入力しないと０になるため。
        arts.datetime_description:
          type: string
        arts.closed_day_description:
          type: string
        institutions.admission_fee_description:
          type: string
        authors.name:
          type: string
    StampsModel:
      description: Response Arts Model.
      type: object
      properties:
        authors.name:
          type: string
          example: レアンドロ・エルリッヒ
        authors.name_kana:
          type: string
          example: レアンドロ・エルリッヒ
        arts.created_year:
          type: integer
          example: 2023
        arts.is_public:
          type: boolean
          example: true
        arts.name:
          type: string
          example: 空の池
        arts.name_kana:
          type: string
          example: そらのいけ
        arts.address:
          type: string
          example: 越後妻有里山現代美術館
        arts.description:
          type: string
          example: キナーレの中央にある回路に囲まれた大きな池の水面に光が反射し、空や建物を鏡のように移している。
        arts.image_path:
          type: string
          example: xxxxxx
        arts.start_date:
          type: string
          example: 2023/06/13
        arts.end_date:
          type: string
          example: 2024/06/13
        arts.closin_day:
          type: string
          example: 2024/06/13
        area.name:
          type: string
          example: KSG
        count(*):
          type: integer
          example: 10

    SuccessModel:
      description: 成功
      required:
        - statusCode
        - message
      type: object
      properties:
        statusCode:
          title: statusCode
          type: integer
          example: 201
        message:
          title: message
          type: string
          example: 成功

    ErrorModel:
      description: Response Error Model.
      required:
        - statusCode
        - message
      type: object
      properties:
        statusCode:
          title: error code
          type: integer
        message:
          title: error message
          type: string

    "DtoModel":
      {
        type: object,
        properties:
          { "property": { "type": "string" }, "message": { "type": "string" } },
      }

  responses:
    SigninResponse:
      description: ログイン成功
      content:
        application/json:
          schema:
            properties:
              access_token:
                type: string
                example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpAVCI9.eyJzdWIiOiIxMjM0NTY3ODkwIrwinFtZSI6KivaG4gRG9lIiwiYWRtaW4iOnRydWUsImlzcyI6Imh0dHA6Ly9zZXJ2aWNlLmNvbS9hdXRoL3YxLzAiLCJleHAiOjE2MzQ1Njc4OTgsImZpbGUiOnRydWUsImF1dGhoul0aWVzImpfXX0.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
              token_type:
                type: string
                example: Bearer
              expires_in:
                type: integer
                example: 3600

    ArtsResponse:
      description: 作品情報を返す。
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ArtsModel"
    ArtsDetailResponse:
      description: 作品の詳細情報を返す。
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ArtsDetailModel"
    StampsResponse:
      description: スタンプの個数と作品情報を返す。
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/StampsModel"

    SignUpResponse:
      description: User登録完了
      content:
        application/json:
          schema:
            properties:
              statusCode:
                example: 201
              message:
                example: created
    SignOutResponse:
      description: サインアウト完了
      content:
        application/json:
          schema:
            properties:
              statusCode:
                example: 201
              message:
                example: サインアウトしました。
    SuccessResponse:
      description: 成功のレスポンス
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/SuccessModel"
    AlreadyEmailResponse:
      description: メールアドレスは既に登録されている場合
      content:
        application/json:
          schema:
            properties:
              statusCode:
                example: 409
              message:
                example: メールアドレスは既に登録されています。
    EmailTransmissionSuccessResponse:
      description: メールが正常に送られたレスポンス。
      content:
        application/json:
          schema:
            properties:
              statusCode:
                example: 201
              message:
                example: メールが正常に送られました。

    BadRequestResponse:
      description: Bad Request.
      content:
        application/json:
          schema:
            type: object
            properties:
              statusCode:
                type: integer
                example: 400
              message:
                type: array
                items:
                  $ref: "#/components/schemas/DtoModel"
    UnauthorizedResponse:
      description: Unauthorized.
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ErrorModel"
            properties:
              statusCode:
                example: 401

    ForbiddenResponse:
      description: |
        Forbidden.
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ErrorModel"
            properties:
              statusCode:
                example: 403
              message:
                example: Forbidden.

    NotFoundResponse:
      description: |
        Not Found.
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ErrorModel"
            properties:
              statusCode:
                example: 404
              message:
                example: Not Found.

    InternalServerErrorResponse:
      description: サーバエラー
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ErrorModel"
            properties:
              statusCode:
                example: 500
              message:
                example: internal server error

  securitySchemes:
    Bearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Credentials or access token for API
